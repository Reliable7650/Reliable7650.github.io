# Lazarus Project Dashboard Updater v5.2 ("Glory")

name: Update Dashboard via Issue

on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Parse Issue Body
        id: extract
        run: |
          issue_body="${{ github.event.issue.body }}"
          if [[ "$issue_body" == *"ã€æ•°æ®æ›´æ–°ã€‘"* ]]; then
            echo "type=DATA_UPDATE" >> $GITHUB_OUTPUT
            echo "$issue_body" | grep ":" | while IFS=: read -r key value; do
              var_name=$(echo "$key" | tr -d '[:space:]' | sed 's/é¡¹ç›®æ€»è¿›åº¦/total_progress/' | sed 's/çŠ¶æ€/_status/' | sed 's/è¿›åº¦/_progress/' | sed 's/æœ€æ–°æ—¥å¿—/latest_log_entry/')
              var_value=$(echo "$value" | xargs)
              echo "${var_name}=${var_value}" >> $GITHUB_OUTPUT
            done
          elif [[ "$issue_body" == *"ã€é‡Œç¨‹ç¢‘ã€‘"* ]]; then
            echo "type=MILESTONE" >> $GITHUB_OUTPUT
            echo "text=$(echo "$issue_body" | sed -n 's/.*ã€é‡Œç¨‹ç¢‘ã€‘//p' | xargs)" >> $GITHUB_OUTPUT
          elif [[ "$issue_body" == *"ã€å®éªŒæ—¥å¿—ã€‘"* ]]; then
            echo "type=LAB_LOG" >> $GITHUB_OUTPUT
            echo "text=$(echo "$issue_body" | sed -n 's/.*ã€å®éªŒæ—¥å¿—ã€‘//p' | xargs)" >> $GITHUB_OUTPUT
          elif [[ "$issue_body" == *"ã€è´¢åŠ¡è®°å½•ã€‘"* ]]; then
            echo "type=FINANCE_LOG" >> $GITHUB_OUTPUT
            echo "item=$(echo "$issue_body" | grep -oP 'é¡¹ç›®: \K.*' | xargs)" >> $GITHUB_OUTPUT
            echo "amount=$(echo "$issue_body" | grep -oP 'é‡‘é¢: \K.*' | xargs)" >> $GITHUB_OUTPUT
            echo "notes=$(echo "$issue_body" | grep -oP 'å¤‡æ³¨: \K.*' | xargs)" >> $GITHUB_OUTPUT
          else
            echo "type=UNKNOWN" >> $GITHUB_OUTPUT
          fi

      - name: Update HTML based on Data Update
        if: steps.extract.outputs.type == 'DATA_UPDATE'
        run: |
          cp index.html temp_index.html
          
          update_milestone() {
            local id=$1
            local status=$2
            local progress=$3
            awk -v id="$id" -v status="$status" -v progress="$progress" '
            BEGIN { in_block=0 }
            /id="'"$id"'"/ { in_block=1 }
            in_block && /<span class="status">/ { sub(/>.*</, ">" status "<") }
            in_block && /<div class="progress-bar"/ { sub(/width: [0-9.]*%;/, "width: " progress "%;"); sub(/>[0-9.]*%</, ">" progress "%<") }
            /<\/div>/ && in_block && /milestone/ { in_block=0 }
            { print }
            ' temp_index.html > new_temp_index.html && mv new_temp_index.html temp_index.html
          }

          update_milestone "dap1" "${{ steps.extract.outputs.dap1_status }}" "${{ steps.extract.outputs.dap1_progress }}"
          update_milestone "dap2" "${{ steps.extract.outputs.dap2_status }}" "${{ steps.extract.outputs.dap2_progress }}"
          update_milestone "dap3" "${{ steps.extract.outputs.dap3_status }}" "${{ steps.extract.outputs.dap3_progress }}"
          update_milestone "mol1" "${{ steps.extract.outputs.mol1_status }}" "${{ steps.extract.outputs.mol1_progress }}"
          update_milestone "mol2" "${{ steps.extract.outputs.mol2_status }}" "${{ steps.extract.outputs.mol2_progress }}"
          update_milestone "mol3" "${{ steps.extract.outputs.mol3_status }}" "${{ steps.extract.outputs.mol3_progress }}"

          sed -i "s|<div class=\"value\" id=\"total_progress_val\">[0-9.]*%</div>|<div class=\"value\" id=\"total_progress_val\">${{ steps.extract.outputs.total_progress }}%</div>|" temp_index.html
          sed -i "s|<div class=\"progress-bar\" id=\"total_progress_bar\" style=\"width: [0-9.]*%;\">|<div class=\"progress-bar\" id=\"total_progress_bar\" style=\"width: ${{ steps.extract.outputs.total_progress }}%;\">|" temp_index.html
          
          if [ -n "${{ steps.extract.outputs.latest_log_entry }}" ]; then
            timestamp=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
            new_log_entry="<div class=\"log-entry\"><span class=\"log-timestamp\">[${timestamp}]</span> <span class=\"log-process\">[AUTO_UPDATE]</span> <span class=\"log-info\">${{ steps.extract.outputs.latest_log_entry }}</span></div>"
            sed -i "1s|^|<div class=\"log-box\" id=\"log-box\">${new_log_entry}|" temp_index.html # A bit of a hack to insert at top
          fi
          
          mv temp_index.html index.html

      - name: Update HTML based on Timeline Event
        if: "steps.extract.outputs.type == 'MILESTONE' || steps.extract.outputs.type == 'LAB_LOG' || steps.extract.outputs.type == 'FINANCE_LOG'"
        run: |
          timestamp=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          html=""
          if [ "${{ steps.extract.outputs.type }}" == "MILESTONE" ]; then
            html="<li class='timeline-item'><div class='timeline-icon'>â­</div><span class='timeline-date'>${timestamp}</span><p class='timeline-content'>${{ steps.extract.outputs.text }}</p></li>"
          elif [ "${{ steps.extract.outputs.type }}" == "LAB_LOG" ]; then
            html="<li class='timeline-item'><div class='timeline-icon'>ğŸ”¬</div><span class='timeline-date'>${timestamp}</span><p class='timeline-content'><b>[å®éªŒæ—¥å¿—]</b> ${{ steps.extract.outputs.text }}</p></li>"
          elif [ "${{ steps.extract.outputs.type }}" == "FINANCE_LOG" ]; then
            html="<li class='timeline-item'><div class='timeline-icon'>ğŸ’°</div><span class='timeline-date'>${timestamp}</span><p class='timeline-content'><b>[è´¢åŠ¡]</b> ${{ steps.extract.outputs.item }} - <b>æ”¯å‡º: ${{ steps.extract.outputs.amount }}</b>. å¤‡æ³¨: ${{ steps.extract.outputs.notes }}</p></li>"
          fi
          sed -i "/<ul class=\"timeline\" id=\"project-timeline\">/a ${html}" index.html
      
      - name: Update Version, Timestamp, and Commit
        if: steps.extract.outputs.type != 'UNKNOWN'
        run: |
          current_version=$(grep "<span id=\"version\">v" index.html | awk -F'v' '{print $2}' | awk -F'</span>' '{print $1}')
          new_version=$(echo "$current_version + 0.1" | bc)
          sed -i "s|<span id=\"version\">v.*</span>|<span id=\"version\">v${new_version}</span>|" index.html
          
          timestamp=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          sed -i "s|<span id=\"update-time\">.*</span>|<span id=\"update-time\">${timestamp}</span>|" index.html
          
          git config --global user.name 'Lazarus Diary Bot'
          git config --global user.email 'bot@lazarus.project'
          git add index.html
          if ! git diff --staged --quiet; then
            git commit -m "Dashboard v${new_version}: ${{ steps.extract.outputs.type }} via issue #${{ github.event.issue.number }}"
            git push
          else
            echo "No changes to commit."
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.LAZARUS_TOKEN }}
          
      - name: Close the Issue
        if: steps.extract.outputs.type != 'UNKNOWN'
        uses: peter-evans/close-issue@v3
        with:
          comment: "æ„Ÿè°¢ä½ çš„æ›´æ–°ï¼Œåˆä¼™äººã€‚æˆ‘å·²ç»å°†è¿™ä¸ªäº‹ä»¶/æ•°æ®è®°å½•åˆ°äº†æˆ‘ä»¬çš„æ—¥è®°ä¸­ã€‚âœ… (v5.2)"
